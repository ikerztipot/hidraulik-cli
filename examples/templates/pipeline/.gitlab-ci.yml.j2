# GitLab CI/CD Pipeline for {{ project_name }}
# Generated by gitlab-cicd-creator
# Project: {{ project_path }}
# Namespace: {{ namespace }}

# Include reusable job definitions from central repository
include:
  - project: '{{ template_repo }}'
    ref: main
    file: '/includes/.build-buildkit-scaleway.yml'

default:
  tags:
{%- for tag in runner_tags %}
    - {{ tag }}
{%- endfor %}

stages:
{%- for component in components %}
  - build-{{ component }}
  {%- if k8s_deployment.get(component, False) %}
  {%- for env in environments %}
  - deploy-{{ component }}-{{ env }}
  {%- endfor %}
  {%- endif %}
{%- endfor %}

variables:
  PROJECT_PATH: {{ project_path }}
  NAMESPACE: {{ namespace }}
  TAG_PREFIX: {{ tag_prefix }}

{% for component in components %}
# ============================================
# {{ component | upper }} PIPELINE
# ============================================

# Build job for {{ component }}
build-{{ component }}:
  stage: build-{{ component }}
  variables:
    DOCKERFILE_PATH: ${CI_PROJECT_DIR}/{{ dockerfile_paths.get(component, 'Dockerfile') }}
    PACKAGE_NAME: {{ component }}
  extends: .build-buildkit-scaleway
  {%- if k8s_deployment.get(component, False) %}
  environment:
    name: {{ environments[0] }}
  {%- endif %}
  rules:
    - if: '$CI_COMMIT_TAG =~ /^{{ tag_prefix }}-{{ component }}-/'

{%- if k8s_deployment.get(component, False) %}

# Hydrate template - Base job for {{ component }}
.hydrate-{{ component }}:
  image:
    name: supinf/envsubst
    entrypoint: [""]
  before_script:
    - echo "Domain = $DOMAIN"
    - echo "Component = {{ component }}"
  script:
    # Process Kubernetes manifests with environment variables
{%- set manifests = k8s_manifests.get(component, []) %}
{%- if 'namespace' in manifests %}
    - envsubst < k8s/{{ component }}/01-namespace.yaml > k8s/namespace.yaml
{%- endif %}
{%- if 'secrets' in manifests %}
    - envsubst < k8s/{{ component }}/02-secrets.yaml > k8s/secrets.yaml
{%- endif %}
{%- if 'configs' in manifests %}
    - envsubst < k8s/{{ component }}/03-configs.yaml > k8s/configs.yaml
{%- endif %}
{%- if 'deployment' in manifests %}
    - envsubst < k8s/{{ component }}/04-deployment.yaml > k8s/deploy.yaml
{%- endif %}
{%- if 'ingress' in manifests %}
    - envsubst < k8s/{{ component }}/05-ingress.yaml > k8s/ingress.yaml
{%- endif %}
{%- if 'service' in manifests %}
    - envsubst < k8s/{{ component }}/06-service.yaml > k8s/service.yaml
{%- endif %}
{%- if 'pvc' in manifests %}
    - envsubst < k8s/{{ component }}/07-pvc.yaml > k8s/pvc.yaml
{%- endif %}
  artifacts:
    expire_in: "1 days"
    paths:
{%- if 'namespace' in manifests %}
      - k8s/namespace.yaml
{%- endif %}
{%- if 'secrets' in manifests %}
      - k8s/secrets.yaml
{%- endif %}
{%- if 'configs' in manifests %}
      - k8s/configs.yaml
{%- endif %}
{%- if 'deployment' in manifests %}
      - k8s/deploy.yaml
{%- endif %}
{%- if 'ingress' in manifests %}
      - k8s/ingress.yaml
{%- endif %}
{%- if 'service' in manifests %}
      - k8s/service.yaml
{%- endif %}
{%- if 'pvc' in manifests %}
      - k8s/pvc.yaml
{%- endif %}
  rules:
    - if: '$CI_COMMIT_TAG =~ /^{{ tag_prefix }}-{{ component }}-/'

{% for env in environments %}
# Hydrate {{ component }} for {{ env }}
hydrate-{{ component }}-{{ env }}:
  stage: deploy-{{ component }}-{{ env }}
  extends: .hydrate-{{ component }}
  environment:
    name: {{ env }}
{% endfor %}

# Deploy template - Base job for {{ component }}
.deploy-{{ component }}:
  image:
    name: bitnamisecure/kubectl:latest
    entrypoint: [""]
  before_script:
    - echo "Deploying to namespace = ${NAMESPACE}"
    - echo "Using context = $KUBE_CONTEXT"
    - if [ -n "$KUBE_CONTEXT" ]; then kubectl config use-context $KUBE_CONTEXT; fi
  script:
    # Restore manifests to original location
{%- if 'namespace' in manifests %}
    - mv -f k8s/namespace.yaml k8s/{{ component }}/01-namespace.yaml
{%- endif %}
{%- if 'secrets' in manifests %}
    - mv -f k8s/secrets.yaml k8s/{{ component }}/02-secrets.yaml
{%- endif %}
{%- if 'configs' in manifests %}
    - mv -f k8s/configs.yaml k8s/{{ component }}/03-configs.yaml
{%- endif %}
{%- if 'deployment' in manifests %}
    - mv -f k8s/deploy.yaml k8s/{{ component }}/04-deployment.yaml
{%- endif %}
{%- if 'ingress' in manifests %}
    - mv -f k8s/ingress.yaml k8s/{{ component }}/05-ingress.yaml
{%- endif %}
{%- if 'service' in manifests %}
    - mv -f k8s/service.yaml k8s/{{ component }}/06-service.yaml
{%- endif %}
{%- if 'pvc' in manifests %}
    - mv -f k8s/pvc.yaml k8s/{{ component }}/07-pvc.yaml
{%- endif %}

    # Display and apply all manifests
    - echo "=== Manifests to apply ==="
    - cat k8s/{{ component }}/*.yaml
    - cat k8s/{{ component }}/*.yaml | kubectl apply --validate=false -f -

    # Wait for rollout to complete
{%- if 'deployment' in manifests %}
    - echo "=== Waiting for deployment rollout ==="
    - kubectl rollout status deployment/{{ component }} -n ${NAMESPACE} --timeout=5m
{%- endif %}

    # Verify deployment status
    - echo "=== Deployment status ==="
    - kubectl get all -n ${NAMESPACE}
{%- if 'secrets' in manifests or 'configs' in manifests %}
    - kubectl get secrets,configmaps -n ${NAMESPACE}
{%- endif %}
{%- if 'ingress' in manifests %}
    - kubectl get ingress -n ${NAMESPACE}
{%- endif %}
{%- if 'pvc' in manifests %}
    - kubectl get pvc -n ${NAMESPACE}
{%- endif %}
  rules:
    - if: '$CI_COMMIT_TAG =~ /^{{ tag_prefix }}-{{ component }}-/'
      when: manual

{% for env in environments %}
# Deploy {{ component }} to {{ env }}
deploy-{{ component }}-{{ env }}:
  stage: deploy-{{ component }}-{{ env }}
  extends: .deploy-{{ component }}
  environment:
    name: {{ env }}
  needs:
    - job: hydrate-{{ component }}-{{ env }}
      artifacts: true
  {%- if env == environments[-1] %}
  when: manual  # Production requires manual approval
  {%- endif %}
{% endfor %}
{%- endif %}

{% endfor %}
